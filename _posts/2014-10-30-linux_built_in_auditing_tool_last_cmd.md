---
layout: post
title: "Linux内置的审计跟踪工具 - last命令"
categories: linux
tags: [linux, last用法]
date: 2014-10-30 16:04:32
---

<p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">如果你是一个服务器管理员，你或许知道你要保护你的服务器的话，不仅是从外部，还要从内部保护。linux有一个内置工具来看到最后登陆服务器的用户，可以帮助你保护服务器。</p><p style="text-align: center; padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);"><img alt="" src="/upload/images/151322lrza1r3qwzkgj66k.png" style="padding: 0px; margin: 0px; border: medium none; max-width: 100%; overflow: hidden;" height="256" width="256"></p><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">这个命令是<strong style="padding: 0px; margin: 0px;">last</strong>。它<strong style="padding: 0px; margin: 0px;">对于追踪非常有用</strong>。让我们来看一下last可以为你做些什么。</p><h3 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">last命令的功能是什么</h3><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);"><strong style="padding: 0px; margin: 0px;">last</strong>显示的是自<strong style="padding: 0px; margin: 0px;">/var/log/wtmp</strong>文件创建起所有登录(和登出)的用户。这个文件是二进制文件，它不能被文本编辑器浏览，比如vi、Joe或者其他软件。这是非常有用的，因为用户(或者root)不能像他们希望的那样修改这个文件。</p><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">last会给出所有已登录用户的用户名、tty、IP地址(如果用户是远程连接的话)、日期-时间和用户已经登录的时间。</p><h3 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">如何运行last</h3><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">你只要在控制台中输入<strong style="padding: 0px; margin: 0px;">last</strong>即可。这是个例子：</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ lastleni pts/0 10.0.76.162 Mon Dec 2 12:32 - 13:25 (00:53)pungki tty1 Mon Dec 2 09:31 still logged inreboot system boot 2.6.32-358.23.2 Mon Dec 2 09:20 - 13:25 (04:05) </pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">这里是如何阅读last信息：</p><ul style="padding: 0px; margin: 0px 0px 0px 25px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);"><li style="padding: 0px; margin: 0px;">第一列告诉谁是用户</li><li style="padding: 0px; margin: 0px;"><p style="padding: 4px; margin: 0px;">第二列给出了用户如何连接的信息</p><ul style="padding: 0px; margin: 0px 0px 0px 25px;"><li style="padding: 0px; margin: 0px;">pts/0 (伪终端) 意味着从诸如SSH或telnet的远程连接的用户</li><li style="padding: 0px; margin: 0px;">tty (teletypewriter) 意味着直接连接到计算机或者本地连接的用户</li><li style="padding: 0px; margin: 0px;">除了重启活动,所有状态会在启动时显示</li></ul></li><li style="padding: 0px; margin: 0px;"><p style="padding: 4px; margin: 0px;">第三列<strong style="padding: 0px; margin: 0px;">显示用户来自哪里</strong>。如果用户来自于远程计算机，你会看到一个主机名或者IP地址。如果你看见:0.0 或者什么都没有，这意味着用户通过本地终端连接。除了重启活动，内核版本会显示在状态中。</p></li><li style="padding: 0px; margin: 0px;"><p style="padding: 4px; margin: 0px;">剩下的列显示<strong style="padding: 0px; margin: 0px;">日志活动发生在何时</strong>。括号中的数字告诉我们连接持续了多少小时和分钟。</p></li></ul><h3 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">日常操作中last的一些示例</h3><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">限制显示行的数目</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">当你有很多行要显示时,你可以限制你想看到的行的数目.使用&nbsp;<strong style="padding: 0px; margin: 0px;">-n 参数</strong>来这么做。</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ last -n 3leni pts/0 10.0.76.162 Mon Dec 2 12:32 - 13:25 (00:53)pungki tty1 Mon Dec 2 09:31 still logged inreboot system boot 2.6.32-358.23.2 Mon Dec 2 09:20 - 13:25 (04:05)</pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);"><strong style="padding: 0px; margin: 0px;">-n</strong>&nbsp;参数会使last显示从当前时间到以后的3条记录。</p><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">不显示主机名</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">使用&nbsp;<strong style="padding: 0px; margin: 0px;">-R</strong>&nbsp;参数来这么做。这里是例子 :</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ last -Rleni pts/0 Mon Dec 2 12:32 - 13:25 (00:53)pungki tty1 Mon Dec 2 09:31 still logged inreboot system boot Mon Dec 2 09:20 - 13:25 (04:05)</pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">如你所见,现在在也没有关于主机或者IP地址的信息了。</p><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">最后一列显示主机名</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">要这么做,我们使用&nbsp;<strong style="padding: 0px; margin: 0px;">-a</strong>参数</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ last -aleni pts/0 Mon Dec 2 12:32 - 13:25 (00:53) 10.0.76.162pungki tty1 Mon Dec 2 09:31 still logged in :0.0reboot system boot Mon Dec 2 09:20 - 13:25 (04:05) 2.6.32-358.23.2.el6.i686</pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">现在主机信息诸如10.0.76.162 会放在最后一列。</p><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">显示完整登入登出时间日期</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">对于此,你可以使用&nbsp;<strong style="padding: 0px; margin: 0px;">-F</strong>&nbsp;参数。这个是个示例:</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ last -Fleni pts/0 10.0.76.162 Mon Dec 2 12:32:24 2013 – Mon Dec 2013 13:25:24 2013 (00:53)</pre><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">打印特定的用户名</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">如果你想要追踪特定的用户,你可以特别打印它。在last命令后面输入用户名。</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ last lenileni tty1 Mon Dec 2 18-42 still logged inleni pts/0 Mon Dec 2 12:32 - 13:25 (00:53) 10.0.76.162</pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">或者你想要知道<strong style="padding: 0px; margin: 0px;">reboot</strong>何时完成，你也可以这样显示它：</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ last rebootreboot system boot Mon Dec 2 09:20 - 16:55 (07:34)reboot system boot Sun Dec 1 04:26 - 04:27 (00:01)reboot system boot Wed Nov 27 20:27 - 01:24 (04:57)reboot system boot Tue Nov 26 21:06 - 06:13 (09:06)</pre><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">打印特定 / pts</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">last同样可以打印特定tty/pts的信息. 只要在last命令后面输入tty名字或者pty名字。</p><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">这里有一些例子:</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ last tty1pungki tty1 Mon Dec 2 09:31 still logged inpungki tty1 Mon Dec 2 04:26 – down (00:00)pungki tty1 Mon Dec 2 04:07 – down (00:00)pungki tty1 Sun Dec 1 18:55 – 04:07 (09:12)$ last pts/0leni pts/0 10.0.76.162 Mon Dec 2 12:32 - 13:25 (00:53)pungki pts/0 :0.0 Wed Nov 27 20:28 – down (04:56)</pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">当你看到&nbsp;<strong style="padding: 0px; margin: 0px;">down 的值</strong>&nbsp;- 比如上面的第二行,它意味着用户从某个时间登录直到系统重启或关机。</p><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">使用另一个文件而不是 /var/log/wtmp</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">默认上，last命令会从<strong style="padding: 0px; margin: 0px;">/var/log/wtmp</strong>中解析信息。如果你想要<strong style="padding: 0px; margin: 0px;">last命令</strong>从另外一个文件解析，你可以使用<strong style="padding: 0px; margin: 0px;">-f</strong>&nbsp;参数。比如，当日志切割后，让我们假设切割后，之前的文件名变为<strong style="padding: 0px; margin: 0px;">/var/log/wtmp.1</strong>。那么last命令会像这样。</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">$ last -f /var/log/wtmp.1</pre><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">显示运行级别改变</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">这里有个<strong style="padding: 0px; margin: 0px;">-x</strong>参数来显示运行级别。这里示例输出:</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">pungki tty1 Mon Dec 2 19:21 still logged inrunlevel (to lvl 3) 2.6.32-358.23.2 Mon Dec 2 19:20 – 19:29 (00:08)reboot system boot 2.6.32-358.23.2 Mon Dec 2 19:20 – 19:29 (00:08)shutdown system down 2.6.32-358.23.2 Mon Dec 2 18:56 – 19:20 (00:23)runlevel (to lvl 0) 2.6.32-358.23.2 Mon Dec 2 18:56 – 18:56 (00:00)leni tty1 Mon Dec 2 18:42 – down (00:00) </pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">你可以看到这里有两个运行级别。运行级别<strong style="padding: 0px; margin: 0px;">to lvl 3</strong>的条目意味着系统运行在完整的控制台模式，而没在X window或者GUI中。同时,当系统<strong style="padding: 0px; margin: 0px;">关机</strong>时，实际上是切换为<strong style="padding: 0px; margin: 0px;">运行级别0</strong>，这就是为什么last会显示<strong style="padding: 0px; margin: 0px;">to lvl 0</strong>。</p><p style="text-align: center; padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);"><img alt="" src="/upload/images/151322dxacjb5krxas9cxh.png" style="padding: 0px; margin: 0px; border: medium none; max-width: 100%; overflow: hidden;" height="512" width="512"></p><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">查看失败登录</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);"><strong style="padding: 0px; margin: 0px;">last</strong>命令用了记录成功登录，而&nbsp;<strong style="padding: 0px; margin: 0px;">lastb</strong>&nbsp;命令<strong style="padding: 0px; margin: 0px;">记录失败的登录尝试</strong>。你<strong style="padding: 0px; margin: 0px;">必须拥有root</strong>权限才能运行lastb命令。这里有一个lastb命令的示例输出。lastb会解析/var/log/btmp的信息。</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);"># lastbleni tty1 Mon Dec 2 22:12 – 22:12 (00:00)rahma tty1 Mon Dec 2 22:11 – 22:11 (00:00) </pre><h4 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">切割日志</h4><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">因为<em style="padding: 0px; margin: 0px;">/var/log/wtmp</em><em style="padding: 0px; margin: 0px;">记录每次的登录活动，文件的大小可能会快速地增长。默认上，Linux会每月</em><em style="padding: 0px; margin: 0px;">切割 /var/log/wtmp/</em><em style="padding: 0px; margin: 0px;">。切割的策略放在/etc/logrotate.conf 文件中。这里是我</em><em style="padding: 0px; margin: 0px;">/etc/logrotate.conf</em>*文件的内容。</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">/var/log/wtmp {　　monthly　　create 0664 root umtp　　minsize 1M　　rotate 1}</pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">对于&nbsp;<strong style="padding: 0px; margin: 0px;">/var/log/btmp</strong>, 这里是默认的倒换活动配置</p><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px; color: rgb(51, 51, 51); line-height: 25px; background-color: rgb(255, 255, 255);">/var/log/btmp {　　missingok　　monthly　　create 0600 root umtp　　minsize 1M　　rotate 1}</pre><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">你可以根据需要自己修改。</p><h3 style="padding: 0px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">总结</h3><p style="padding: 4px; margin: 0px; color: rgb(51, 51, 51); font-family: Verdana,Arial,Tahoma; line-height: 25px; background-color: rgb(255, 255, 255);">你可以结合这些参数来自定义last和lastb的输出。所有可以<strong style="padding: 0px; margin: 0px;">运行于last命令</strong>的参数都<strong style="padding: 0px; margin: 0px;">可运行在</strong>lastb命令上。更多细节,请通过在控制台输入<strong style="padding: 0px; margin: 0px;">man last</strong>来访问。</p>
