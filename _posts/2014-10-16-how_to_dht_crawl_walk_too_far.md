---
layout: post
title: "如何让DHT爬虫走得更远"
categories: 网络
tags: [dht, 网络爬虫, dht爬虫]
date: 2014-10-16 23:05:38
---

前些天在北上火车途中的时候, 闲着无聊, 脑子里一直在思考怎么让DHT爬虫走得更远? 怎么降低重复收到infohash的announce_peer请求? 怎么我只需认识少量的节点, 而让更多节点认识我? 想呀想, 想呀想, 不知不觉就睡着了, 可能是火车摇篮效应吧.

只所以还想挑战自己的DHT爬虫极限, 是因为我要跟那个btbook.net作者(华仔)玩"蚂蚁战大象", 我蚂蚁, 他大象, 因为他服务器带宽很高, 我的很低, 服务器配置也低.

........

梦里, 我还在不停地敲代码, 也许梦里的人脑子更聪明吧, 我tmd知道怎么做了!!! 哈哈!! 兴奋得不小心就醒了, 立马登上QQ群, 向群里人和华仔"炫耀"了番, 就等着赶快到北京, 找个网络测下梦里写的代码.

........

总算到了北京, 随意找了个地儿住了下来, 可是, 尼玛, 我居然忘记要写那极限代码了, 居然去写跟btbook.net类似的东西去了, 三天后, 总算写了个跟这个很像的东西, 不过sphinx索引出了问题, 发布了一小时的网站就匆忙地关闭了. 整了好久都搞不懂为嘛索引出错, 哎, 先放在一旁.

又无聊了, 睡不着, 继续去优化我那DHT爬虫去, 把在火车梦到的代码拿来实践下, 加了个函数, 在别的地儿修改了两行代码, 放在国外VPS测试, 我艹! 15分钟居然收集到了22000个独一无二的infohash, 重复率大大降低! 兴奋之极, 立马又在群里炫耀了一番.

现在说说是怎么个思路, 大体来说还是跟华仔曾说过的一大概思路相似, 不知道我的跟他的细节上是不是一样的:

向DHT网络第一个节点发出find_node请求的时候, target就是自身节点ID, 一直不停地递归find_node话, 最后自身路由表差不多就有(160-2) * K 那么多离自身"最较近"的节点了. 但是, 认识你的都是些"100米"之内的"邻居", 其实"200米"之内的"邻居"也跟那"100米"之内的"邻居"是"差不多"的, 他们也应该认识你, 但是target也只有在写自己的时候, 才能认识离自身较近的, 但我想更远的人认识我怎么办?

答案就是:

每隔一段时间检查自身路由表的节点数是不是有超过 (160-2) * K 的80%那么多, 若是的话, 差不多周围"100米"之内的"邻居"都认识你了. 该让周围"200米"之内的邻居认识你了. 那么就把target给更换为离自身node ID较近的. 怎么生成离自身node ID较近的target呢? 很简单, 先随机生成一个20字节的SHA1值作为初始target, 然后把前3字节的字符串换为自身node ID的前3位字符串, 这样就差不多是在离自己"200米"之内. so easy!

那么, 你也许会问, 在刷新路由表的时候, 发出的find_node里的target又写啥? 当然是写原始的自身node ID咯. 反正那"100米", "200米"之内的邻居几乎都会回复的.

笔者的爬虫: https://github.com/laomayi/simDHT (PS: 别看时间是2月份的, 那是取我虚拟机里的gentoo时间, 好久没矫正时间了. 事实最后git push是几个小时前), 那极限代码就在kdht.py里changeNodeID方法里.

本人所在QQ群: 97912038 欢迎加入交流, 笔者非群主也非管理员.
