---
layout: post
title: "总结：用net-snmp开发snmp代理客户端"
categories: 网络
tags: [net-snmp]
date: 2014-10-24 10:05:26
---

<span style="font-size: small;">前段时间一直在做snmp代理。从一无所知到把项目做完。一些总结写在这里，分享给需要的人。</span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: -18pt; margin: 0cm 0cm 0pt 18pt;"><strong style=""><span style="" lang="EN-US"><span style=""><span style="font-family: Times New Roman;"><span style="font-size: small;">1.</span><span style="font: 7pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></strong><span style="font-size: small;"><strong style=""><span style="font-family: 宋体;">开发</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib</span></span></strong><strong style=""><span style="font-family: 宋体;">文件</span></strong></span></p>
<p class="MsoNormal" style="text-indent: 18pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;">mib</span></span><span style="font-family: 宋体;">文件的格式是：起始行；</span><span lang="EN-US"><span style="font-family: Times New Roman;">import</span></span><span style="font-family: 宋体;">；从根节点开始，一层层往下，每一层都可在上层找到依赖关系。具体实现可参考安装包内</span><span lang="EN-US"><span style="font-family: Times New Roman;">mibs/ NET-SNMP-EXAMPLES-MIB.txt</span></span></span></p>
<p class="MsoNormal" style="text-indent: 18pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">注：对于可添加删除的表格，则</span><span lang="EN-US"><span style="font-family: Times New Roman;">table</span></span><span style="font-family: 宋体;">必须额外添加一项</span><span lang="EN-US"><span style="font-family: Times New Roman;">Row Status</span></span><span style="font-family: 宋体;">。用于标识行的添加删除修改。</span></span></p>
<p class="MsoNormal" style="text-indent: 18pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">将设计好的</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib</span></span><span style="font-family: 宋体;">文件拷到</span><span lang="EN-US"><span style="font-family: Times New Roman;">/usr/local/share/snmp/mibs/</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: -18pt; margin: 0cm 0cm 0pt 18pt;"><strong style=""><span style="" lang="EN-US"><span style=""><span style="font-family: Times New Roman;"><span style="font-size: small;">2.</span><span style="font: 7pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></strong><span style="font-size: small;"><strong style=""><span style="font-family: 宋体;">用</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib2c</span></span></strong><strong style=""><span style="font-family: 宋体;">工具生成</span><span lang="EN-US"><span style="font-family: Times New Roman;">*.c *.h</span></span></strong><strong style=""><span style="font-family: 宋体;">文件</span></strong></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 18pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 18pt;"><span style="font-size: small;"><span style="font-family: 宋体;">设置环境变量，用对应配置文件生成<span class="wp_keywordlink"><a href="http://www.doc5188.com/" title="代码" target="_blank">代码</a></span>。注意要用</span><span lang="EN-US"><span style="font-family: Times New Roman;">root</span></span><span style="font-family: 宋体;">权限。</span></span></p>
<p class="MsoNormal" style="text-indent: 21pt; margin: 0cm 0cm 0pt 21pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">export MIBS=ALL;</span></span></p>
<p class="MsoNormal" style="text-indent: 21pt; margin: 0cm 0cm 0pt 21pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">mib2c –c configure mibnode</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>configure</span></span><span style="font-family: 宋体;">选择：</span></span></p>
<p class="MsoNormal" style="text-indent: 18pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">表格用</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib2c.iterate_access.conf</span></span><span style="font-family: 宋体;">或</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib2c.iterate.conf</span></span></span></p>
<p class="MsoNormal" style="text-indent: 18pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">节点用</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib2c.scalar.conf</span></span></span></p>
<p class="MsoNormal" style="text-indent: 18pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;">Trap</span></span><span style="font-family: 宋体;">用</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib2c.notify.conf</span></span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">（如果没有生成文件，检查前几步是否正确完成）</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">（参考安装包内</span><span lang="EN-US"><span style="font-family: Times New Roman;">agent/mibgroup/example/ </span></span><span style="font-family: 宋体;">下的文件完成开发）</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: -18pt; margin: 0cm 0cm 0pt 18pt;"><strong style=""><span style="" lang="EN-US"><span style=""><span style="font-family: Times New Roman;"><span style="font-size: small;">3.</span><span style="font: 7pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></strong><span style="font-size: small;"><strong style=""><span style="font-family: 宋体;">修改添加生成的</span><span lang="EN-US"><span style="font-family: Times New Roman;">.c</span></span></strong><strong style=""><span style="font-family: 宋体;">文件，完成<span class="wp_keywordlink"><a href="http://www.doc5188.com/" title="源代码" target="_blank">源代码</a></span>的编写。</span></strong></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: -18pt; margin: 0cm 0cm 0pt 23.25pt;"><span style="font-family: 宋体;" lang="EN-US"><span style=""><span style="font-size: small;">a)</span><span style="font: 7pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-family: 宋体;"><span style="font-size: small;">节点方式函数</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span style="font-family: Times New Roman;"><span style="font-size: small;"><strong style=""><span lang="EN-US">handle_XXX</span></strong><span lang="EN-US">(netsnmp_mib_handler *handler,</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>netsnmp_handler_registration *reginfo,</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>netsnmp_agent_request_info *reqinfo,</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>netsnmp_request_info *requests)</span></span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;">MODE_GET</span></span><span style="font-family: 宋体;">用于</span><span lang="EN-US"><span style="font-family: Times New Roman;">get</span></span><span style="font-family: 宋体;">操作；</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;">MODE_SET_COMMIT</span></span><span style="font-family: 宋体;">用于写操作。从</span><span lang="EN-US"><span style="font-family: Times New Roman;">requests-&gt;requestvb-&gt;val.integer/string</span></span><span style="font-family: 宋体;">获取节点数据。</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: -18pt; margin: 0cm 0cm 0pt 23.25pt;"><span style="font-family: Times New Roman;"><span style="" lang="EN-US"><span style=""><span style="font-size: small;">b)</span><span style="font: 7pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US"><span style="font-size: small;">table</span></span></span><span style="font-size: small;"><span style="font-family: 宋体;">方式函数说明（</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib2c.iterate_access.conf</span></span><span style="font-family: 宋体;">）：</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><strong style=""><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;">initialize_table_xxxTable(void)</span></span></span></strong></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">模块初始化</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><strong style=""><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;">xxxTable_handler</span></span></span></strong></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">表格处理函数句柄</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><strong style=""><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;">xxxTable_createEntry</span></span></span></strong></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">传入表格参数，新建一个结构，将各参数依次赋给结构内各项。最后将结构添加在</span><span lang="EN-US"><span style="font-family: Times New Roman;">xxxTable_head</span></span><span style="font-family: 宋体;">的前面作为首节点。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><strong style=""><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;">xxxTable_removeEntry</span></span></span></strong></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">此函数可借用</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib2c.iterate.conf</span></span><span style="font-family: 宋体;">文件生成的函数。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;">entry</span></span><span style="font-family: 宋体;">的意思表示是表格的入口，是在</span><span lang="EN-US"><span style="font-family: Times New Roman;">mib</span></span><span style="font-family: 宋体;">文件中设置的（</span><span lang="EN-US"><span style="font-family: Times New Roman;">index</span></span><span style="font-family: 宋体;">项）。可查看</span><span lang="EN-US"><span style="font-family: Times New Roman;">netsnmp_table_helper_add_indexes</span></span><span style="font-family: 宋体;">函数的第二个参数注释。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><strong style=""><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;">xxxTable_get_first_data_point</span></span></span></strong></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">手动创建链表，每个节点包含一行</span><span lang="EN-US"><span style="font-family: Times New Roman;">table</span></span><span style="font-family: 宋体;">内容，头结点赋给</span><span lang="EN-US"><span style="font-family: Times New Roman;">xxxTable_head</span></span><span style="font-family: 宋体;">。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">将</span><span lang="EN-US"><span style="font-family: Times New Roman;">xxxTable_head</span></span><span style="font-family: 宋体;">赋给</span><span lang="EN-US"><span style="font-family: Times New Roman;"> *my_loop_context</span></span><span style="font-family: 宋体;">。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><strong style=""><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;">xxxTable_get_next_data_point</span></span></span></strong></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">需要填写</span><span lang="EN-US"><span style="font-family: Times New Roman;">snmp_set_var_value(idx, (u_char *)xxx, sizeof(xxx))</span></span><span style="font-family: 宋体;">的后两个参数，</span><span lang="EN-US"><span style="font-family: Times New Roman;">xxx</span></span><span style="font-family: 宋体;">为</span><span lang="EN-US"><span style="font-family: Times New Roman;">index</span></span><span style="font-family: 宋体;">项。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><strong style=""><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;">xxxTable_create_data_context(netsnmp_variable_list * index_data, int column)</span></span></span></strong></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">创建一个结构模板，</span><span lang="EN-US"><span style="font-family: Times New Roman;">entry</span></span><span style="font-family: 宋体;">项由</span><span lang="EN-US"><span style="font-family: Times New Roman;">index_data</span></span><span style="font-family: 宋体;">传入，如下例：</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;">entry-&gt;IPLineID = *(index_data-&gt;val.integer); </span></span><span style="font-family: 宋体;">其他的项随便填。如有</span><span lang="EN-US"><span style="font-family: Times New Roman;">RowStatus</span></span><span style="font-family: 宋体;">项，则</span><span lang="EN-US"><span style="font-family: Times New Roman;">RowStatus</span></span><span style="font-family: 宋体;">初始化为</span><span lang="EN-US"><span style="font-family: Times New Roman;">0</span></span><span style="font-family: 宋体;">。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">将创建的结构体添加到</span><span lang="EN-US"><span style="font-family: Times New Roman;">xxxTable_head</span></span><span style="font-family: 宋体;">的头结点前面。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">本函数在在</span><span lang="EN-US"><span style="font-family: Times New Roman;">xxxTable_handler</span></span><span style="font-family: 宋体;">函数中调用，默认生成的模板里第二个参数为空，编译会出错，填入</span><span lang="EN-US"><span style="font-family: Times New Roman;">1</span></span><span style="font-family: 宋体;">。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><strong style=""><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;">xxxTable_commit_row(void **my_data_context, int new_or_del)</span></span></span></strong></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">具体的添加修改删除行的操作在这个函数里进行。例：</span></span></p>
<p class="MsoNormal" style="text-indent: 21pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">struct IPLineTable_entry *entry = (IPL_t *)*my_data_context;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="font-size: small;"><span style="">&nbsp;&nbsp;&nbsp;&nbsp; </span>switch (entry-&gt;RowStatus)</span></span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">根据</span><span lang="EN-US"><span style="font-family: Times New Roman;">entry-&gt;RowStatus</span></span><span style="font-family: 宋体;">的不同类型区分不同的操作。</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-family: Times New Roman;"><span style="font-size: small;"><strong style=""><span lang="EN-US">Get_xxx</span></strong><span lang="EN-US"> <strong style="">(void *data_context, size_t *ret_len)</strong></span></span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">获取节点数据内容</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-family: Times New Roman;"><span style="font-size: small;"><strong style=""><span lang="EN-US">Set_xxx</span></strong><span lang="EN-US"> <strong style="">(void *data_context, long *val, size_t val_len)</strong></span></span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">设置节点内容</span></span></p>
<p class="MsoNormal" style="text-indent: 5.25pt; margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: -18pt; margin: 0cm 0cm 0pt 23.25pt;"><span style="font-family: Times New Roman;"><span style="" lang="EN-US"><span style=""><span style="font-size: small;">c)</span><span style="font: 7pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span lang="EN-US"><span style="font-size: small;">trap</span></span></span><span style="font-family: 宋体;"><span style="font-size: small;">函数</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span style="font-size: small;"><span style="font-family: 宋体;">发送</span><span lang="EN-US"><span style="font-family: Times New Roman;">trap</span></span><span style="font-family: 宋体;">有两种方式，一种是脚本中用</span><span lang="EN-US"><span style="font-family: Times New Roman;">snmptrap</span></span><span style="font-family: 宋体;">发送，一种是在<span class="wp_keywordlink"><a href="http://www.doc5188.com/" title="程序" target="_blank">程序</a></span>内用函数发送。发送函数：</span><span lang="EN-US"><span style="font-family: Times New Roman;">send_xxxTrap_trap()</span></span><span style="font-family: 宋体;">。</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span style="font-size: small;"><span style="font-family: 宋体;">需要填写两个</span><span lang="EN-US"><span style="font-family: Times New Roman;">snmp_varlist_add_variable</span></span><span style="font-family: 宋体;">函数。</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">snmp_varlist_add_variable(&amp;var_list, snmptrap_oid, OID_LENGTH(snmptrap_oid),</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 126pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">ASN_OBJECT_ID, (u_char *)xxxTrap_oid, sizeof(xxxTrap_oid));</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">snmp_varlist_add_variable(&amp;var_list, yyy_oid, OID_LENGTH(yyy_oid),</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;"><span style="">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>ASN_OCTET_STR, string, strlen(string))</span></span><span style="font-family: 宋体;">；</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt 5.25pt;"><span style="font-size: small;"><span lang="EN-US"><span style="font-family: Times New Roman;">xxxTrap_oid</span></span><span style="font-family: 宋体;">是</span><span lang="EN-US"><span style="font-family: Times New Roman;">trap</span></span><span style="font-family: 宋体;">节点号，</span><span lang="EN-US"><span style="font-family: Times New Roman;">yyy_oid</span></span><span style="font-family: 宋体;">是关联节点号，</span><span lang="EN-US"><span style="font-family: Times New Roman;">string</span></span><span style="font-family: 宋体;">即为要发送的字符串。</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="text-indent: -18pt; margin: 0cm 0cm 0pt 18pt;"><strong style=""><span style="" lang="EN-US"><span style=""><span style="font-family: Times New Roman;"><span style="font-size: small;">4.</span><span style="font: 7pt &quot;Times New Roman&quot;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></strong><strong style=""><span style="font-size: small;"><span style="font-family: 宋体;">编译</span></span></strong></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">添加扩展采用动态库方式</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">生成动态库：</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">gcc -g -I/root/net-snmp-5.2.2/include/ -c -o example.o example.c </span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">gcc -g -fPIC -shared -o example.so example.o</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-family: 宋体;"><span style="font-size: small;">装载动态库到程序节点</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">需要配置文件：</span><span lang="EN-US"><span style="font-family: Times New Roman;">/etc/snmp/snmpd.conf </span></span><span style="font-family: 宋体;">中添加</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">dlmod<span style="">&nbsp;&nbsp; </span>example<span style="">&nbsp;&nbsp;&nbsp; </span>/root/snmpdll/ example.so</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span style="font-size: small;"><span style="font-family: 宋体;">然后重新启动</span><span lang="EN-US"><span style="font-family: Times New Roman;">snmpd</span></span><span style="font-family: 宋体;">程序。</span></span></p>
<p class="MsoNormal" style="margin: 0cm 0cm 0pt;"><span lang="EN-US"><span style="font-family: Times New Roman; font-size: small;">&nbsp;</span></span></p>
<p>&nbsp;</p>
